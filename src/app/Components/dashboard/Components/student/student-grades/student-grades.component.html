<div class="container mt-4">
  <h3 class="main-title">درجات الطالب</h3>

  <!-- أزرار الفلترة -->
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <button
      class="outline-btn"
      [class.primary-btn]="filter === 'all'"
      (click)="filter = 'all'"
    >
      الكل
    </button>
    <button
      class="outline-btn"
      [class.primary-btn]="filter === 'assignments'"
      (click)="filter = 'assignments'"
    >
      أعمال السنة
    </button>
    <button
      class="outline-btn"
      [class.primary-btn]="filter === 'finals'"
      (click)="filter = 'finals'"
    >
      الاختبارات النهائية
    </button>
    <button
      class="outline-btn"
      [class.primary-btn]="filter === 'online'"
      (click)="filter = 'online'"
    >
      الاختبارات الأونلاين
    </button>
    <button
      class="outline-btn"
      [class.primary-btn]="filter === 'offline'"
      (click)="filter = 'offline'"
    >
      الاختبارات الأوفلاين
    </button>
  </div>

  <!-- حالة التحميل -->
  <div *ngIf="!ExamsResults" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">جاري التحميل...</span>
    </div>
    <p class="mt-2">جاري تحميل النتائج...</p>
  </div>

  <!-- جدول الدرجات -->
  <div *ngIf="ExamsResults" class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>المادة</th>
          <th>المعلم</th>
          <th>النوع</th>
          <th>العنوان</th>
          <th>التاريخ</th>
          <th>(أقل/النهائية) النسبة</th>
          <th>الدرجة</th>
          <th>الحالة</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let result of ExamsResults">
          <td>{{ result.subjectName }}</td>
          <td>{{ result.teacherName }}</td>
          <td>
            {{ result.examName }}
          </td>
          <td>{{ result.examName }}</td>
          <td>{{ result.date | date : "dd/MM/yyyy" }}</td>
          <td>
            {{ result.minMark }} / {{ result.fullMark }}
            <span class="text-muted small">{{ result.percentage }}%</span>
          </td>
          <td>
            {{ result.totalMark }}
          </td>
          <td>
            {{ result.status }}
          </td>
          <td>
            <button
              class="btn btn-primary btn-sm"
              (click)="showCorrection(result.studentId, result.examId)"
              title="عرض التصحيح"
              [disabled]="loadingCorrection"
            >
              <span
                *ngIf="loadingCorrection"
                class="spinner-border spinner-border-sm me-1"
              ></span>
              <i *ngIf="!loadingCorrection" class="fas fa-eye me-1"></i>
              عرض التصحيح
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- مودال عرض التصحيح -->
<div
  class="modal fade show"
  [class.d-block]="showCorrectionModal"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
>
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-check-circle me-2"></i>
          تصحيح الإجابات
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="closeCorrectionModal()"
          aria-label="إغلاق"
        ></button>
      </div>

      <div class="modal-body">
        <!-- حالة التحميل -->
        <div *ngIf="loadingCorrection" class="text-center py-5">
          <div
            class="spinner-border text-primary"
            style="width: 3rem; height: 3rem"
            role="status"
          >
            <span class="visually-hidden">جاري التحميل...</span>
          </div>
          <p class="mt-3">جاري تحميل التصحيح...</p>
        </div>

        <!-- محتوى التصحيح -->
        <div *ngIf="!loadingCorrection && selectedCorrectionData.length > 0">
          <!-- ملخص النتائج -->
          <div class="summary-card mb-4">
            <div class="row text-center">
              <div class="col-md-3 mb-3">
                <div class="stat-item">
                  <h3 class="text-primary mb-1">
                    {{ getTotalCorrectAnswers() }}
                  </h3>
                  <p class="mb-0 text-white-50">الإجابات الصحيحة</p>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-item">
                  <h3 class="text-warning mb-1">
                    {{ getTotalQuestions() - getTotalCorrectAnswers() }}
                  </h3>
                  <p class="mb-0 text-white-50">الإجابات الخاطئة</p>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-item">
                  <h3 class="text-success mb-1">
                    {{ getTotalStudentMarks() }}
                  </h3>
                  <p class="mb-0 text-white-50">الدرجة المحصلة</p>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-item">
                  <h3 class="text-info mb-1">{{ getTotalPossibleMarks() }}</h3>
                  <p class="mb-0 text-white-50">الدرجة الكلية</p>
                </div>
              </div>
            </div>
            <div class="row text-center mt-2">
              <div class="col-12">
                <div class="progress" style="height: 10px">
                  <div
                    class="progress-bar bg-success"
                    [style.width]="getPercentage() + '%'"
                    role="progressbar"
                    [attr.aria-valuenow]="getPercentage()"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
                <p class="mt-2 mb-0 text-white-50">
                  النسبة: {{ getPercentage() }}%
                </p>
              </div>
            </div>
          </div>

          <!-- الأسئلة والإجابات -->
          <div class="container-fluid">
            <div class="questions-container">
              <div
                *ngFor="let answer of selectedCorrectionData; let i = index"
                class="question-card mb-4"
                [class]="getAnswerStatusClass(answer)"
              >
                <div class="card shadow-sm">
                  <div
                    class="card-header d-flex justify-content-between align-items-center bg-light"
                  >
                    <h6 class="mb-0 text-dark">
                      <i class="fas fa-question-circle me-2 text-primary"></i>
                      سؤال {{ i + 1 }}
                    </h6>
                    <div class="d-flex align-items-center gap-2">
                      <span
                        class="badge"
                        [ngClass]="{
                          'bg-success': answer.isCorrect,
                          'bg-danger': !answer.isCorrect
                        }"
                      >
                        {{ answer.isCorrect ? "صحيحة" : "خاطئة" }}
                      </span>
                      <span class="badge bg-secondary">
                        {{ answer.questionDegree }} درجة
                      </span>
                    </div>
                  </div>

                  <div class="card-body">
                    <!-- نص السؤال -->
                    <div class="question-content mb-4">
                      <h6 class="text-dark mb-2">
                        <i class="fas fa-file-alt me-2 text-primary"></i>
                        نص السؤال:
                      </h6>
                      <p class="mb-0 p-3 bg-light rounded border">
                        {{ answer.questionContent }}
                      </p>
                    </div>

                    <div class="row">
                      <!-- إجابة الطالب -->
                      <div class="col-md-6 mb-3">
                        <div class="answer-section">
                          <h6 class="text-primary mb-3">
                            <i class="fas fa-user-graduate me-2"></i>
                            إجابة الطالب:
                          </h6>
                          <div
                            class="student-answer p-3 rounded border"
                            [ngClass]="{
                              'bg-danger text-white': !answer.isCorrect,
                              'bg-success text-white': answer.isCorrect
                            }"
                          >
                            <div class="d-flex align-items-center">
                              <i
                                class="fas"
                                [ngClass]="{
                                  'fa-check-circle me-2': answer.isCorrect,
                                  'fa-times-circle me-2': !answer.isCorrect
                                }"
                              ></i>
                              <span>{{ getStudentAnswerText(answer) }}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- الإجابة الصحيحة -->
                      <div class="col-md-6 mb-3">
                        <div class="answer-section">
                          <h6 class="text-success mb-3">
                            <i class="fas fa-check-double me-2"></i>
                            الإجابة الصحيحة:
                          </h6>
                          <div
                            class="correct-answer p-3 bg-success text-white rounded border border-success"
                          >
                            <div class="d-flex align-items-center">
                              <i class="fas fa-check-circle me-2"></i>
                              <span>{{ getCorrectAnswerText(answer) }}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- تفاصيل إضافية -->
                    <div class="row mt-3">
                      <div class="col-12">
                        <div class="marks-section p-3 bg-light rounded border">
                          <div class="row text-center">
                            <div class="col-md-4">
                              <strong>الدرجة المحصلة:</strong>
                              <span class="fw-bold text-primary ms-1">{{
                                answer.studentMark || 0
                              }}</span>
                            </div>
                            <div class="col-md-4">
                              <strong>الدرجة الكاملة:</strong>
                              <span class="fw-bold text-success ms-1">{{
                                answer.questionDegree
                              }}</span>
                            </div>
                            <div class="col-md-4">
                              <strong>نوع السؤال:</strong>
                              <span class="badge bg-info ms-1">{{
                                answer.questionType
                              }}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- حالة عدم وجود بيانات -->
        <div
          *ngIf="!loadingCorrection && selectedCorrectionData.length === 0"
          class="text-center py-5"
        >
          <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">لا توجد بيانات للعرض</h5>
          <p class="text-muted">لم يتم العثور على بيانات التصحيح</p>
        </div>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeCorrectionModal()"
        >
          <i class="fas fa-times me-1"></i>
          إغلاق
        </button>
      </div>
    </div>
  </div>
</div>

<!-- خلفية المودال -->
<div class="modal-backdrop fade show" *ngIf="showCorrectionModal"></div>
