<div class="container mt-4">
  <h3 class="main-title">إدارة حسابات الأولياء الأمور</h3>

  <!-- أزرار الفلترة -->
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <button
      class="outline-btn"
      [class.primary-btn]="selectedStatus === 'all'"
      (click)="selectedStatus = 'all'"
    >
      جميع الأولياء الأمور
    </button>
    <button
      class="outline-btn"
      [class.primary-btn]="selectedStatus === accountStatusEnum.Pending"
      (click)="selectedStatus = accountStatusEnum.Pending"
    >
      قيد الانتظار
    </button>
    <button
      class="outline-btn"
      [class.primary-btn]="selectedStatus === accountStatusEnum.Active"
      (click)="selectedStatus = accountStatusEnum.Active"
    >
      نشط
    </button>
    <button
      class="outline-btn"
      [class.primary-btn]="selectedStatus === accountStatusEnum.Rejected"
      (click)="selectedStatus = accountStatusEnum.Rejected"
    >
      مرفوض
    </button>
    <button
      class="outline-btn"
      [class.primary-btn]="selectedStatus === accountStatusEnum.Blocked"
      (click)="selectedStatus = accountStatusEnum.Blocked"
    >
      محظور
    </button>
  </div>

  <!-- عرض جميع الأولياء الأمور -->
  <div class="row g-3">
    <div *ngFor="let parent of filteredParents()" class="col-md-6 col-lg-4">
      <div class="card p-3 h-100 d-flex flex-column justify-content-between">
        <div>
          <h5 class="sub-title mb-1">{{ parent.fullName }}</h5>
          <p class="text-muted mb-1">
            <i class="fas fa-envelope me-1"></i>
            {{ parent.email }}
          </p>
          <p class="text-muted mb-1" *ngIf="parent.contactInfo">
            <i class="fas fa-phone me-1"></i>
            {{ parent.contactInfo }}
          </p>
        </div>

        <div class="mt-3 d-flex justify-content-between align-items-center">
          <span
            class="badge"
            [ngClass]="'bg-' + getStatusColor(parent.accountStatus)"
          >
            {{ getStatusName(parent.accountStatus) }}
          </span>

          <div class="d-flex gap-2 flex-wrap">
            <!-- زر الموافقة -->
            <button
              class="primary-btn btn-sm"
              *ngIf="isParentPending(parent) || isParentRejected(parent)"
              (click)="ApproveParentAction(parent.id)"
              title="موافقة"
            >
              <i class="fas fa-check me-1"></i> قبول
            </button>

            <!-- زر الرفض -->
            <button
              class="outline-btn btn-sm"
              *ngIf="isParentPending(parent)"
              (click)="RejectParentAction(parent.id)"
              title="رفض"
            >
              <i class="fas fa-times me-1"></i> رفض
            </button>

            <!-- زر الحظر -->
            <button
              class="danger-btn btn-sm"
              *ngIf="isParentActive(parent)"
              (click)="BlockParentAction(parent.id)"
              title="حظر"
            >
              <i class="fas fa-ban me-1"></i> حظر
            </button>

            <!-- زر فك الحظر -->
            <button
              class="success-btn btn-sm"
              *ngIf="isParentBlocked(parent)"
              (click)="UnblockParentAction(parent.id)"
              title="فك الحظر"
            >
              <i class="fas fa-unlock me-1"></i> فك الحظر
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- رسالة عدم وجود الأولياء الأمور -->
  <div
    *ngIf="filteredParents().length === 0 && allparents.length > 0"
    class="alert alert-info mt-4"
  >
    لا توجد الأولياء الأمور بحالة "{{
      selectedStatus === "all"
        ? "جميع"
        : selectedStatus === accountStatusEnum.Pending
        ? "قيد الانتظار"
        : selectedStatus === accountStatusEnum.Active
        ? "نشط"
        : selectedStatus === accountStatusEnum.Rejected
        ? "مرفوض"
        : selectedStatus === accountStatusEnum.Blocked
        ? "محظور"
        : ""
    }}"
  </div>

  <!-- رسالة عدم وجود الأولياء الأمور مطلقا -->
  <div
    *ngIf="allparents.length === 0 && !isLoading"
    class="alert alert-warning mt-4"
  >
    لا يوجد أولياء الأمور مسجلين في النظام
  </div>
</div>

<!-- POPUP MODAL FOR ASSIGNING STUDENT -->
<div *ngIf="showAssignModal" class="assign-modal-backdrop fade show">
  <div class="assign-modal-content">
    <!-- Modal Header -->
    <div class="assign-modal-header">
      <h4 class="assign-modal-title">تعيين طالب للوالد/ة</h4>
      <button
        type="button"
        class="assign-modal-close-btn"
        (click)="closeAssignModal()"
      >
        &times;
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Parent Info -->
      <div class="alert parent-info-alert mb-4">
        <div class="parent-info-content">
          <i class="fas fa-user-circle parent-info-icon"></i>
          <div>
            <strong>اسم القريب: </strong> {{ selectedParentNameForModal }}
          </div>
        </div>
      </div>

      <!-- Search Input -->
      <div class="mb-4">
        <label class="form-label fw-medium mb-2"> ابحث عن طالب: </label>
        <div class="d-flex gap-2">
          <div class="search-input-wrapper">
            <input
              type="text"
              class="form-control search-input"
              [(ngModel)]="searchQuery"
              (keyup.enter)="searchStudentsInPopup()"
              placeholder="اكتب اسم الطالب، البريد الإلكتروني، رقم الإقامة أو رقم الهوية..."
            />
            <div class="search-icon">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <button
            type="button"
            class="btn btn-primary search-btn"
            (click)="searchStudentsInPopup()"
            [disabled]="searchQuery.length < 2"
          >
            <i class="fas fa-search me-1"></i> بحث
          </button>
        </div>
        <div
          *ngIf="searchQuery.length > 0 && searchQuery.length < 2"
          class="text-muted small mt-1"
        >
          اكتب حرفين على الأقل للبحث
        </div>
      </div>

      <!-- Loading Spinner -->
      <div *ngIf="isSearching" class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">جاري البحث...</span>
        </div>
        <p class="text-muted mt-2">جاري البحث عن الطلاب...</p>
      </div>

      <!-- Search Results -->
      <div *ngIf="searchResults.length > 0" class="mb-4">
        <h6 class="mb-3">نتائج البحث:</h6>
        <div class="search-results-container">
          <div
            *ngFor="let student of searchResults"
            class="student-item"
            [class.selected]="selectedStudent?.id === student.id"
            (click)="selectStudentInPopup(student)"
          >
            <div class="student-info">
              <div>
                <div class="student-name">
                  {{ student.fullName }}
                </div>
                <div class="student-details">
                  <div>
                    <i class="fas fa-envelope me-1"></i> {{ student.email }}
                  </div>
                  <div *ngIf="student.IqamaNumber">
                    <i class="fas fa-id-card me-1"></i>
                    {{ student.IqamaNumber }}
                  </div>
                  <div *ngIf="student.PassportNumber">
                    <i class="fas fa-passport me-1"></i>
                    {{ student.PassportNumber }}
                  </div>
                </div>
              </div>
              <div
                *ngIf="selectedStudent?.id === student.id"
                class="student-selected-icon"
              >
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- No Results -->
      <div
        *ngIf="
          hasPerformedSearch &&
          searchQuery.length >= 2 &&
          searchResults.length === 0 &&
          !isSearching
        "
        class="alert alert-warning mb-4"
      >
        <i class="fas fa-exclamation-triangle me-2"></i>
        لم يتم العثور على طلاب مطابقين للبحث
      </div>

      <!-- Selected Student Info -->
      <div *ngIf="selectedStudent" class="selected-student-container mb-4 p-3">
        <h6 class="selected-student-title mb-2">
          <i class="fas fa-user-check me-2"></i>الطالب المحدد:
        </h6>
        <div class="selected-student-grid">
          <div><strong>الاسم:</strong> {{ selectedStudent.fullName }}</div>
          <div>
            <strong>البريد الإلكتروني:</strong> {{ selectedStudent.email }}
          </div>
          <div *ngIf="selectedStudent.IqamaNumber">
            <strong>رقم الإقامة:</strong> {{ selectedStudent.IqamaNumber }}
          </div>
          <div *ngIf="selectedStudent.PassportNumber">
            <strong>رقم الجواز:</strong> {{ selectedStudent.PassportNumber }}
          </div>
        </div>
      </div>

      <!-- Relation Selection -->
      <div class="mb-4">
        <label class="form-label fw-medium mb-2"> العلاقة: </label>
        <select class="form-select" [(ngModel)]="relation">
          <option value="father">أب</option>
          <option value="mother">أم</option>
          <option value="gaurdian">وصى</option>
          <option value="other">أخر</option>
        </select>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="assign-modal-footer">
      <button
        type="button"
        class="btn btn-secondary modal-action-btn"
        (click)="closeAssignModal()"
      >
        إلغاء
      </button>
      <button
        type="button"
        class="btn btn-primary modal-action-btn"
        (click)="assignStudentToParentInPopup()"
        [disabled]="!selectedStudent || isAssigning"
      >
        <span *ngIf="!isAssigning">
          <i class="fas fa-link me-1"></i> تعيين
        </span>
        <span *ngIf="isAssigning">
          <span
            class="spinner-border spinner-border-sm me-2"
            role="status"
            aria-hidden="true"
          ></span>
          جاري التعيين...
        </span>
      </button>
    </div>
  </div>
</div>
