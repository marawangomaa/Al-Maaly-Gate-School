<div class="admin-teachers-container">
  <!-- Header Section -->
  <div class="header-section">

    <div class="d-flex flex-column gap-4">
      <h2>{{ "parents.management" | translate }}</h2>
      <div>
        <p class="paragraph">
          {{ "parents.instructions" | translate }}
        </p>
        <p class="paragraph">
          {{ "parents.instructions2" | translate }}
        </p>
        <p class="paragraph">
          {{ "parents.instructions3" | translate }}
        </p>
        <p class="paragraph">
          {{ "parents.instructions4" | translate }}
        </p>
      </div>
    </div>

    <!-- Filter Buttons -->
    <div class="d-flex gap-2 flex-wrap mb-4 mt-4">
      <button class="btn outline-btn" [class.btn-primary]="selectedStatus === 'all'" (click)="selectedStatus = 'all'">
        <i class="fas fa-users me-1"></i> {{ "parents.allParents" | translate }}
      </button>
      <button class="btn outline-btn" [class.btn-primary]="selectedStatus === accountStatusEnum.Pending"
        (click)="selectedStatus = accountStatusEnum.Pending">
        <i class="fas fa-clock me-1"></i> {{ "parents.pending" | translate }}
      </button>
      <button class="btn outline-btn" [class.btn-primary]="selectedStatus === accountStatusEnum.Active"
        (click)="selectedStatus = accountStatusEnum.Active">
        <i class="fas fa-check-circle me-1"></i>
        {{ "parents.active" | translate }}
      </button>
      <button class="btn outline-btn" [class.btn-primary]="selectedStatus === accountStatusEnum.Rejected"
        (click)="selectedStatus = accountStatusEnum.Rejected">
        <i class="fas fa-times-circle me-1"></i>
        {{ "parents.rejected" | translate }}
      </button>
      <button class="btn outline-btn" [class.btn-primary]="selectedStatus === accountStatusEnum.Blocked"
        (click)="selectedStatus = accountStatusEnum.Blocked">
        <i class="fas fa-ban me-1"></i> {{ "parents.blocked" | translate }}
      </button>
    </div>
  </div>
  <br><br>

  <!-- CREATE PARENT BUTTON -->
  <button class="btn btn-primary mb-3 action-btn" (click)="openCreateParentModal()">
    <i class="bi bi-plus-circle me-2"></i>{{ 'parents.create.open' | translate }}
  </button>
  <br><br>
  <button class="btn btn-primary mb-3 action-btn" (click)="parentFile.click()">
    Import Parents from Excel
  </button>


  <input type="file" #parentFile hidden accept=".xlsx" (change)="onExcelSelected(parentFile, 'parent')" />
  <br><br>
  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">{{ "parents.loading" | translate }}</span>
    </div>
    <p class="mt-3 text-muted">{{ "parents.loadingParents" | translate }}</p>
  </div>

  <!-- Parents Grid -->
  <div class="row g-4" *ngIf="!isLoading">
    <div *ngFor="let parent of filteredParents()" class="col-md-6 col-lg-4">
      <div class="grade-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5>{{ parent.fullName }}</h5>
          <span class="badge" [ngClass]="'bg-' + getStatusColor(parent.accountStatus)">
            {{ getStatusName(parent.accountStatus) }}
          </span>
        </div>

        <div class="card-body">
          <!-- Parent Info -->
          <div class="mb-3">
            <p class="text-muted mb-2">
              <i class="fas fa-envelope me-2"></i>
              {{ parent.email }}
            </p>
            <p class="text-muted mb-3" *ngIf="parent.contactInfo">
              <i class="fas fa-phone me-2"></i>
              {{ parent.contactInfo }}
            </p>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="d-flex gap-2 flex-wrap">
              <!-- Approve Button -->
              <button class="btn btn-success btn-sm" *ngIf="isParentPending(parent) || isParentRejected(parent)"
                (click)="ApproveParentAction(parent.id)" [title]="'parents.approve' | translate">
                <i class="fas fa-check me-1"></i>
                {{ "parents.approve" | translate }}
              </button>

              <!-- Parent Docs Button -->
              <button class="btn btn-info btn-sm" (click)="GetParentDocs(parent.appUserId)"
                [title]="'parents.viewDocs' | translate" *ngIf="isParentPending(parent) || isParentRejected(parent)">
                <i class="fas fa-file-pdf me-1"></i>
                {{ "parents.viewDocs" | translate }}
                <span *ngIf="parent.docCount" class="badge bg-white text-info ms-1">
                  {{ parent.docCount }}
                </span>
              </button>

              <!-- Reject Button -->
              <button class="btn btn-outline-danger btn-sm" *ngIf="isParentPending(parent)"
                (click)="RejectParentAction(parent.id)" [title]="'parents.reject' | translate">
                <i class="fas fa-times me-1"></i>
                {{ "parents.reject" | translate }}
              </button>

              <!-- Block Button -->
              <button class="btn btn-danger btn-sm" *ngIf="isParentActive(parent)"
                (click)="BlockParentAction(parent.id)" [title]="'parents.block' | translate">
                <i class="fas fa-ban me-1"></i>
                {{ "parents.block" | translate }}
              </button>

              <!-- Unblock Button -->
              <button class="btn btn-warning btn-sm" *ngIf="isParentBlocked(parent)"
                (click)="UnblockParentAction(parent.id)" [title]="'parents.unblock' | translate">
                <i class="fas fa-unlock me-1"></i>
                {{ "parents.unblock" | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty States -->
  <div *ngIf="!isLoading">
    <!-- No parents in filtered category -->
    <div *ngIf="filteredParents().length === 0 && allparents.length > 0" class="alert alert-info mt-4 text-center">
      <i class="fas fa-info-circle me-2"></i>
      {{ "parents.noParentsInCategory" | translate }}
      <span *ngIf="selectedStatus !== 'all'">
        ({{ getStatusDisplayName(selectedStatus) | translate }})
      </span>
    </div>

    <!-- No parents at all -->
    <div *ngIf="allparents.length === 0 && !isLoading" class="text-center py-5">
      <i class="fas fa-user-friends fa-4x text-muted mb-4"></i>
      <h4 class="mb-3">{{ "parents.noParents" | translate }}</h4>
      <p class="text-muted mb-4">
        {{ "parents.noParentsInCategory" | translate }}
      </p>
    </div>
  </div>
</div>

<!-- POPUP MODAL FOR ASSIGNING STUDENT -->
<div *ngIf="showAssignModal" class="modal fade show" style="display: block">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title">
          {{ "parents.modal.assignStudent" | translate }}
        </h5>
        <button type="button" class="btn-close" (click)="closeAssignModal()"
          [attr.aria-label]="'cOMMON.close' | translate"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <!-- Parent Info -->
        <div class="alert alert-info mb-4">
          <div class="d-flex align-items-center">
            <i class="fas fa-user-circle fa-2x me-3 text-primary"></i>
            <div>
              <strong>{{ "parents.modal.parentName" | translate }}: </strong>
              {{ selectedParentNameForModal }}
            </div>
          </div>
        </div>

        <!-- Search Input -->
        <div class="mb-4">
          <label class="form-label fw-medium mb-2">
            {{ "parents.modal.searchStudent" | translate }}:
          </label>
          <div class="d-flex gap-2 align-items-center">
            <div class="input-group">
              <input type="text" class="form-control" [(ngModel)]="searchQuery"
                (keyup.enter)="searchStudentsInPopup(selectedParentIdForModal)"
                [placeholder]="'parents.modal.searchPlaceholder' | translate" />
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
            </div>
            <button type="button" class="btn btn-primary" (click)="searchStudentsInPopup(selectedParentIdForModal)"
              [disabled]="searchQuery.length < 2">
              <i class="fas fa-search me-1"></i>
              {{ "COMMON.search" | translate }}
            </button>
          </div>
          <div *ngIf="searchQuery.length > 0 && searchQuery.length < 2" class="text-muted small mt-1">
            {{ "parents.modal.minChars" | translate }}
          </div>
        </div>

        <!-- Loading Spinner -->
        <div *ngIf="isSearching" class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{{
              "COMMON.loading" | translate
              }}</span>
          </div>
          <p class="text-muted mt-2">
            {{ "parents.modal.searching" | translate }}
          </p>
        </div>

        <!-- Search Results -->
        <div *ngIf="searchResults.length > 0" class="mb-4">
          <h6 class="mb-3">{{ "parents.modal.searchResults" | translate }}:</h6>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>{{ "parents.modal.name" | translate }}</th>
                  <th>{{ "parents.modal.email" | translate }}</th>
                  <th>{{ "parents.modal.idNumber" | translate }}</th>
                  <th>{{ "parents.modal.PassportNumber" | translate }}</th>
                  <th>{{ "parents.modal.status" | translate }}</th>
                  <th>{{ "parents.modal.action" | translate }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let student of searchResults" [class.table-primary]="selectedStudent?.id === student.id"
                  [class.table-warning]="student.isInRelation">
                  <td>{{ student.fullName }}</td>
                  <td>{{ student.email }}</td>
                  <td>
                    {{ student.iqamaNumber }}
                  </td>
                  <td>
                    {{ student.passportNumber }}
                  </td>
                  <td>
                    <span *ngIf="student.isInRelation" class="badge bg-success">
                      {{ "parents.modal.alreadyAssigned" | translate }}
                    </span>
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm" [class.btn-primary]="selectedStudent?.id !== student.id"
                      [class.btn-success]="selectedStudent?.id === student.id" [disabled]="student.isInRelation"
                      (click)="selectStudentInPopup(student)">
                      <span *ngIf="selectedStudent?.id === student.id">
                        <i class="fas fa-check-circle me-1"></i>
                        {{ "parents.modal.selected" | translate }}
                      </span>
                      <span *ngIf="selectedStudent?.id !== student.id">
                        {{ "parents.modal.select" | translate }}
                      </span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- No Results -->
        <div *ngIf="
            hasPerformedSearch &&
            searchQuery.length >= 2 &&
            searchResults.length === 0 &&
            !isSearching
          " class="alert alert-warning mb-4">
          <i class="fas fa-exclamation-triangle me-2"></i>
          {{ "parents.modal.noResults" | translate }}
        </div>

        <!-- Selected Student Info -->
        <div *ngIf="selectedStudent" class="selected-student-container p-3 mb-4">
          <h6 class="mb-3">
            <i class="fas fa-user-check me-2 text-success"></i>
            {{ "parents.modal.selectedStudent" | translate }}:
          </h6>
          <div class="row">
            <div class="col-md-6 mb-2">
              <strong>{{ "parents.modal.name" | translate }}:</strong>
              {{ selectedStudent.fullName }}
            </div>
            <div class="col-md-6 mb-2">
              <strong>{{ "parents.modal.email" | translate }}:</strong>
              {{ selectedStudent.email }}
            </div>
            <div class="col-md-6 mb-2" *ngIf="selectedStudent.IqamaNumber">
              <strong>{{ "parents.modal.iqamaNumber" | translate }}:</strong>
              {{ selectedStudent.IqamaNumber }}
            </div>
            <div class="col-md-6 mb-2" *ngIf="selectedStudent.PassportNumber">
              <strong>{{ "parents.modal.passportNumber" | translate }}:</strong>
              {{ selectedStudent.PassportNumber }}
            </div>
          </div>
        </div>

        <!-- Relation Selection -->
        <div class="mb-4">
          <label class="form-label fw-medium mb-2">
            {{ "parents.modal.relation" | translate }}:
          </label>
          <select class="form-select" [(ngModel)]="relation">
            <option value="father" *ngIf="gender && gender === 'male'">
              {{ "parents.relations.father" | translate }}
            </option>
            <option value="mother" *ngIf="gender && gender === 'female'">
              {{ "parents.relations.mother" | translate }}
            </option>
            <option value="guardian">
              {{ "parents.relations.guardian" | translate }}
            </option>
            <!-- <option value="other">
              {{ "parents.relations.other" | translate }}
            </option> -->
          </select>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAssignModal()">
          {{ "COMMON.cancel" | translate }}
        </button>
        <button type="button" class="btn btn-primary" (click)="assignStudentToParentInPopup()"
          [disabled]="!selectedStudent || isAssigning">
          <span *ngIf="!isAssigning">
            <i class="fas fa-link me-1"></i>
            {{ "parents.modal.assign" | translate }}
          </span>
          <span *ngIf="isAssigning">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {{ "parents.modal.assigning" | translate }}
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showAssignModal" class="modal-backdrop fade show"></div>

<!-- DOCUMENTS REVIEW MODAL (PLACE THIS OUTSIDE THE ASSIGN MODAL - at the same level) -->
<div *ngIf="showDocsModal" class="modal fade show" style="display: block">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header bg-light">
        <h5 class="modal-title">
          <i class="fas fa-file-pdf me-2 text-danger"></i>
          {{ "parents.modal.documentsReview" | translate }}
        </h5>
        <button type="button" class="btn-close" (click)="closeDocsModal()"
          [attr.aria-label]="'COMMON.close' | translate"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <!-- Parent Info -->
        <div class="alert alert-primary mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ "parents.modal.parentName" | translate }}: </strong>
              {{ selectedParentNameForModal }}
            </div>
            <div class="badge bg-info">
              {{ parentDocuments.length }}
              {{ "parents.modal.documents" | translate }}
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoadingDocs" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{{
              "COMMON.loading" | translate
              }}</span>
          </div>
          <p class="text-muted mt-3">
            {{ "parents.modal.loadingDocs" | translate }}
          </p>
        </div>

        <!-- Documents List and Viewer -->
        <div *ngIf="!isLoadingDocs" class="row">
          <!-- Documents List Sidebar -->
          <div class="col-md-4 border-end">
            <h6 class="mb-3">
              <i class="fas fa-list me-2"></i>
              {{ "parents.modal.documentsList" | translate }}
            </h6>

            <div class="list-group">
              <a *ngFor="let doc of parentDocuments; let i = index" href="javascript:void(0)"
                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                [class.active]="i === currentDocIndex" (click)="loadPdfDocument(i)">
                <div class="d-flex align-items-center">
                  <i class="fas {{
                      getFileIcon(doc.relativePath)
                    }} me-2 text-primary"></i>
                  <div class="text-truncate" style="max-width: 200px">
                    {{ getFileName(doc.relativePath) }}
                  </div>
                </div>
                <span *ngIf="i === currentDocIndex" class="badge bg-success">
                  <i class="fas fa-eye"></i>
                </span>
              </a>
            </div>

            <!-- No Documents Message -->
            <div *ngIf="parentDocuments.length === 0" class="alert alert-warning mt-3">
              <i class="fas fa-exclamation-circle me-2"></i>
              {{ "parents.messages.noDocs" | translate }}
            </div>
          </div>

          <!-- PDF Viewer Area -->
          <div class="col-md-8">
            <div *ngIf="showPdfViewer && currentPdfUrl" class="pdf-viewer-container">
              <!-- PDF Navigation Controls -->
              <div class="pdf-controls d-flex justify-content-between align-items-center mb-3">
                <div>
                  <button class="btn btn-outline-primary btn-sm me-2" (click)="previousDocument()"
                    [disabled]="currentDocIndex === 0">
                    <i class="fas fa-chevron-left me-1"></i>
                    {{ "parents.modal.previous" | translate }}
                  </button>
                  <button class="btn btn-outline-primary btn-sm" (click)="nextDocument()"
                    [disabled]="currentDocIndex === parentDocuments.length - 1">
                    {{ "parents.modal.next" | translate }}
                    <i class="fas fa-chevron-right ms-1"></i>
                  </button>
                </div>

                <div class="text-muted">
                  {{ currentDocIndex + 1 }} / {{ parentDocuments.length }}
                </div>

                <div>
                  <button class="btn btn-outline-success btn-sm me-2" (click)="downloadCurrentDocument()">
                    <i class="fas fa-download me-1"></i>
                    {{ "parents.modal.download" | translate }}
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" (click)="showPdfViewer = !showPdfViewer">
                    <i class="fas fa-times me-1"></i>
                    {{ "parents.modal.closeViewer" | translate }}
                  </button>
                </div>
              </div>

              <!-- Current Document Info -->
              <div class="alert alert-info mb-3">
                <div class="d-flex align-items-center">
                  <i class="fas {{
                      getFileIcon(
                        parentDocuments[currentDocIndex].relativePath!
                      )
                    }} fa-lg me-3"></i>
                  <div class="text-truncate">
                    <strong>{{
                      "parents.modal.currentDocument" | translate
                      }}:</strong>
                    {{
                    getFileName(
                    parentDocuments[currentDocIndex].relativePath!
                    )
                    }}
                  </div>
                </div>
              </div>

              <!-- PDF Viewer -->
              <div class="pdf-frame-container border rounded">
                <iframe [src]="currentPdfUrl" class="pdf-frame" width="100%" height="600" frameborder="0"
                  allowfullscreen>
                  <p class="text-muted p-3">
                    {{ "parents.modal.browserNotSupport" | translate }}
                    <a [href]="currentPdfUrl" target="_blank" class="btn btn-link">
                      {{ "parents.modal.downloadToView" | translate }}
                    </a>
                  </p>
                </iframe>
              </div>

              <!-- Fallback for mobile/unsupported browsers -->
              <div class="mt-3 text-center">
                <a [href]="currentPdfUrl" target="_blank" class="btn btn-primary">
                  <i class="fas fa-external-link-alt me-1"></i>
                  {{ "parents.modal.openInNewTab" | translate }}
                </a>
              </div>
            </div>

            <!-- Instructions when no PDF is selected -->
            <div *ngIf="!showPdfViewer" class="text-center py-5">
              <i class="fas fa-file-pdf fa-4x text-muted mb-3"></i>
              <h5 class="mb-3">
                {{ "parents.modal.selectDocument" | translate }}
              </h5>
              <p class="text-muted">
                {{ "parents.modal.selectFromList" | translate }}
              </p>
              <button class="btn btn-primary" (click)="showPdfViewer = true" *ngIf="parentDocuments.length > 0">
                <i class="fas fa-eye me-1"></i>
                {{ "parents.modal.viewFirstDoc" | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDocsModal()">
          {{ "COMMON.close" | translate }}
        </button>
        <div class="text-muted small">
          <i class="fas fa-info-circle me-1"></i>
          {{ "parents.modal.reviewInstructions" | translate }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop for documents modal -->
<div *ngIf="showDocsModal" class="modal-backdrop fade show"></div>

<!-- CONFIRMATION MODAL (Placed outside main container) -->
<div *ngIf="isConfirmModalOpen" class="modal fade show" style="display: block; z-index: 1054">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Action</h5>
        <button type="button" class="btn-close" (click)="closeConfirm()"></button>
      </div>
      <div class="modal-body">
        <p>{{ confirmModalMessage }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeConfirm()">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="confirmYes()">
          Yes, Continue
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="isConfirmModalOpen" class="modal-backdrop fade show" style="z-index: 1053"></div>

<!-- Create parent modal -->
<div class="modal fade show d-block" *ngIf="isCreateParentModalOpen" tabindex="-1" style="background: rgba(0,0,0,.5);">

  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">
          {{ 'parents.create.title' | translate }}
        </h5>
        <button type="button" class="btn-close" (click)="closeCreateParentModal()"></button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="createParent()" #parentForm="ngForm">

          <div class="mb-3">
            <label>Email</label>
            <input class="form-control" name="email" type="email" [(ngModel)]="createParentModel.email" required />
          </div>

          <div class="mb-3">
            <label>Username</label>
            <input class="form-control" name="userName" [(ngModel)]="createParentModel.userName" required />
          </div>

          <div class="mb-3">
            <label>Full Name</label>
            <input class="form-control" name="fullName" [(ngModel)]="createParentModel.fullName" required />
          </div>

          <div class="mb-3">
            <label>Gender</label>
            <select class="form-select" name="gender" [(ngModel)]="createParentModel.gender" required>
              <option value="">-- Select --</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>

          <div class="mb-3">
            <label>Birth Date</label>
            <input class="form-control" type="date" name="birthDay" [(ngModel)]="createParentModel.birthDay" required />
          </div>

          <div class="mb-3">
            <label>Contact Info</label>
            <input class="form-control" name="contactInfo" [(ngModel)]="createParentModel.contactInfo" />
          </div>

          <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" (click)="closeCreateParentModal()">
              {{ 'common.cancel' | translate }}
            </button>

            <button type="submit" class="btn btn-primary" [disabled]="isCreatingParent">
              {{ isCreatingParent
              ? ('common.loading' | translate)
              : ('parents.create.submit' | translate) }}
            </button>
          </div>

        </form>
      </div>

    </div>
  </div>
</div>