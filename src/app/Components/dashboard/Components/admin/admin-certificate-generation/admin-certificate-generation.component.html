<div class="container">
  <div class="page-header">
    <h2 class="hero-title">{{ 'certificate2.title' | translate }}</h2>
    <p class="page-description text-muted">
      {{ 'certificate2.subtitle' | translate }}
    </p>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation mb-4">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'generate'"
      (click)="switchTab('generate')"
    >
      {{ 'certificate2.tabs.generate' | translate }}
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'bulk'"
      (click)="switchTab('bulk')"
    >
      {{ 'certificate2.tabs.bulk' | translate }}
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'search'"
      (click)="switchTab('search')"
    >
      {{ 'certificate2.tabs.search' | translate }}
    </button>
  </div>

  <!-- MESSAGE -->
  <div 
    *ngIf="message" 
    class="message fade-card"
    [class.message-success]="messageType === 'success'"
    [class.message-error]="messageType === 'error'"
  >
    {{ message }}
  </div>

  <!-- GENERATE TAB -->
  <div *ngIf="activeTab === 'generate'" class="fade-in">
    <!-- Selection Section -->
    <div class="selection-grid">

      <!-- FILTER BY CURRICULUM -->
      <div class="card fade-card">
        <label class="sub-title">{{ 'certificate2.filterByCurriculum' | translate }}</label>
        <select 
          [(ngModel)]="selectedCurriculumId"
          (change)="onCurriculumChange()"
          class="custom-select"
        >
          <option value="">{{ 'certificate2.allCurricula' | translate }}</option>
          <option *ngFor="let curriculum of curricula" [value]="curriculum.id">
            {{ curriculum.name }} ({{ curriculum.code }})
          </option>
        </select>
      </div>

      <!-- FILTER BY GRADE -->
      <div class="card fade-card">
        <label class="sub-title">{{ 'certificate2.filterByGrade' | translate }}</label>
        <select 
          [(ngModel)]="selectedGradeId"
          (change)="onGradeChange()"
          class="custom-select"
        >
          <option value="">{{ 'certificate2.allGrades' | translate }}</option>
          <option *ngFor="let grade of grades" [value]="grade.id">
            {{ grade.gradeName }} 
            <span *ngIf="grade.curriculumName">({{ grade.curriculumName }})</span>
          </option>
        </select>
      </div>

      <!-- CLASS -->
      <div class="card fade-card">
        <label class="sub-title">{{ 'certificate2.selectClass' | translate }}</label>
        <select 
          [(ngModel)]="selectedClassId" 
          (change)="onClassChange()"
          class="custom-select"
          [disabled]="filteredClasses.length === 0"
        >
          <option value="">{{ filteredClasses.length === 0 ? ('certificate2.noClassesAvailable' | translate) : ('certificate2.classPlaceholder' | translate) }}</option>
          <option *ngFor="let class of filteredClasses" [value]="class.id">
            {{ class.className }} - {{ class.gradeName }}
          </option>
        </select>
        <small *ngIf="filteredClasses.length === 0" class="text-muted">
          {{ 'certificate2.noClassesForFilters' | translate }}
        </small>
      </div>

      <!-- CLASS-WIDE CERTIFICATE SETTINGS -->
      <div class="card fade-card" *ngIf="selectedClassId">
        <label class="sub-title">{{ 'certificate2.classWideCertificateType' | translate }}</label>
        <select 
          [(ngModel)]="classWideDegreeType"
          class="custom-select"
        >
          <option *ngFor="let type of degreeTypes" [value]="type">
            {{ type }}
          </option>
        </select>
      </div>

      <!-- CLASS-WIDE ACADEMIC YEAR -->
      <div class="card fade-card" *ngIf="selectedClassId">
        <label class="sub-title">{{ 'certificate2.classWideAcademicYear' | translate }}</label>
        <select 
          [(ngModel)]="classWideAcademicYear"
          class="custom-select"
        >
          <option *ngFor="let year of academicYears" [value]="year">
            {{ year }}
          </option>
        </select>
      </div>

    </div>

    <!-- CLASS-WIDE ACTION BUTTONS -->
    <div class="button-row fade-card" *ngIf="selectedClassId">
      <div class="class-wide-header mb-3">
        <h4 class="main-title">
          {{ 'certificate2.classWideOperations' | translate }}
          <span class="badge bg-info ms-2">
            {{ getStudentCount() }} {{ 'certificate2.students' | translate }}
          </span>
        </h4>
        <p class="text-muted">
          {{ 'certificate2.classWideDescription' | translate }}
        </p>
      </div>

      <div class="button-group">
        <button 
          (click)="generateClassWideCertificates()"
          [disabled]="isGeneratingClassWide || !selectedClassId"
          class="primary-btn action-btn"
        >
          {{ isGeneratingClassWide ? ('certificate2.generatingClassWide' | translate) : ('certificate2.generateClassWide' | translate) }}
        </button>

        <button 
          (click)="downloadClassWideCertificates()"
          [disabled]="isDownloadingClassWide || !selectedClassId"
          class="primary-btn action-btn blue-btn"
        >
          {{ isDownloadingClassWide ? ('certificate2.downloadingClassWide' | translate) : ('certificate2.downloadClassWide' | translate) }}
        </button>
      </div>
    </div>

    <!-- SINGLE STUDENT SECTION -->
    <div *ngIf="selectedClassId" class="single-student-section fade-card mt-4">
      <h4 class="main-title">{{ 'certificate2.singleStudentOperations' | translate }}</h4>
      
      <div class="selection-grid">
        <!-- STUDENT SEARCH -->
        <div class="card fade-card" *ngIf="students.length > 0">
          <label class="sub-title">{{ 'certificate2.searchStudent' | translate }}</label>
          <input 
            type="text"
            [(ngModel)]="searchFilters.studentName"
            (input)="searchStudents()"
            class="custom-select"
            placeholder="{{ 'certificate2.searchStudentPlaceholder' | translate }}"
          >
        </div>

        <!-- STUDENT SELECTION -->
        <div class="card fade-card" *ngIf="filteredStudents.length > 0">
          <label class="sub-title">{{ 'certificate2.selectStudent' | translate }}</label>
          <select 
            [(ngModel)]="selectedStudentId"
            class="custom-select"
          >
            <option value="">{{ 'certificate2.studentPlaceholder' | translate }}</option>
            <option *ngFor="let student of filteredStudents" [value]="student.id">
              {{ student.fullName }}
            </option>
          </select>
        </div>

        <!-- SINGLE CERTIFICATE TYPE -->
        <div class="card fade-card" *ngIf="selectedStudentId">
          <label class="sub-title">{{ 'certificate2.certificateType' | translate }}</label>
          <select 
            [(ngModel)]="selectedDegreeType"
            class="custom-select"
          >
            <option *ngFor="let type of degreeTypes" [value]="type">
              {{ type }}
            </option>
          </select>
        </div>

        <!-- SINGLE ACADEMIC YEAR -->
        <div class="card fade-card" *ngIf="selectedStudentId">
          <label class="sub-title">{{ 'certificate2.academicYear' | translate }}</label>
          <select 
            [(ngModel)]="selectedAcademicYear"
            class="custom-select"
          >
            <option *ngFor="let year of academicYears" [value]="year">
              {{ year }}
            </option>
          </select>
        </div>
      </div>

      <!-- SINGLE STUDENT ACTION BUTTONS -->
      <div class="button-row mt-4" *ngIf="selectedStudentId && selectedDegreeType">
        <button 
          (click)="generateCertificate(false)"
          [disabled]="isGenerating"
          class="primary-btn action-btn"
        >
          {{ isGenerating ? ('certificate2.generating' | translate) : ('certificate2.generatePdf' | translate) }}
        </button>

        <button 
          (click)="generateCertificate(true)"
          [disabled]="isGenerating"
          class="primary-btn action-btn green-btn"
        >
          {{ isGenerating ? ('certificate2.saving' | translate) : ('certificate2.generateAndSave' | translate) }}
        </button>

        <button 
          (click)="saveToDatabase()"
          [disabled]="isSaving"
          class="danger-btn action-btn purple-btn"
        >
          {{ isSaving ? ('certificate2.saving' | translate) : ('certificate2.saveOnly' | translate) }}
        </button>
      </div>
    </div>

    <!-- STUDENTS GRID -->
    <div *ngIf="students.length > 0" class="students-section fade-card mt-4">
      
      <h3 class="main-title">{{ 'certificate2.studentsInClass' | translate }} ({{ students.length }})</h3>

      <div class="students-grid">
        <div 
          *ngFor="let student of filteredStudents"
          class="student-card"
          [class.student-selected]="selectedStudentId === student.id"
          (click)="selectStudent(student)"
        >
          <h4>{{ student.fullName }}</h4>
          <p class="text-muted">{{ 'certificate2.studentId' | translate }}: {{ student.id }}</p>
          <small class="text-muted">{{ student.email }}</small>
        </div>
      </div>

    </div>
  </div>

  <!-- BULK TAB -->
  <div *ngIf="activeTab === 'bulk'" class="fade-in">
    <div class="bulk-section fade-card">
      <h3 class="main-title">{{ 'certificate2.bulkGeneration' | translate }}</h3>
      
      <div class="selection-grid">
        <!-- BULK CLASS -->
        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.selectClass' | translate }}</label>
          <select 
            [(ngModel)]="bulkClassId"
            class="custom-select"
          >
            <option value="">{{ 'certificate2.classPlaceholder' | translate }}</option>
            <option *ngFor="let class of getBulkFilteredClasses()" [value]="class.id">
              {{ class.className }} - {{ class.gradeName }}
            </option>
          </select>
        </div>

        <!-- BULK CERTIFICATE TYPE -->
        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.certificateType' | translate }}</label>
          <select 
            [(ngModel)]="bulkDegreeType"
            class="custom-select"
          >
            <option *ngFor="let type of degreeTypes" [value]="type">
              {{ type }}
            </option>
          </select>
        </div>

        <!-- BULK ACADEMIC YEAR -->
        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.academicYear' | translate }}</label>
          <select 
            [(ngModel)]="bulkAcademicYear"
            class="custom-select"
          >
            <option *ngFor="let year of academicYears" [value]="year">
              {{ year }}
            </option>
          </select>
        </div>
      </div>

      <!-- BULK ACTION BUTTONS -->
      <div class="button-row mt-4">
        <button 
          (click)="bulkGenerateCertificates()"
          [disabled]="isBulkGenerating || !bulkClassId"
          class="primary-btn action-btn"
        >
          {{ isBulkGenerating ? ('certificate2.bulkGenerating' | translate) : ('certificate2.bulkGenerate' | translate) }}
        </button>

        <button 
          (click)="downloadBulkCertificates()"
          [disabled]="isDownloadingBulk || !bulkClassId"
          class="primary-btn action-btn blue-btn"
        >
          {{ isDownloadingBulk ? ('certificate2.downloading' | translate) : ('certificate2.downloadBulk' | translate) }}
        </button>
      </div>
    </div>
  </div>

  <!-- SEARCH TAB -->
  <div *ngIf="activeTab === 'search'" class="fade-in">
    <div class="search-section fade-card">
      <h3 class="main-title">{{ 'certificate2.searchCertificates' | translate }}</h3>
      
      <!-- SEARCH FILTERS -->
      <div class="selection-grid">
        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.studentName' | translate }}</label>
          <input 
            type="text"
            [(ngModel)]="searchFilters.studentName"
            class="custom-select"
            placeholder="{{ 'certificate2.studentNamePlaceholder' | translate }}"
          >
        </div>

        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.certificateNumber' | translate }}</label>
          <input 
            type="text"
            [(ngModel)]="searchFilters.certificateNumber"
            class="custom-select"
            placeholder="{{ 'certificate2.certificateNumberPlaceholder' | translate }}"
          >
        </div>

        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.certificateType' | translate }}</label>
          <select 
            [(ngModel)]="searchFilters.degreeType"
            class="custom-select"
          >
            <option value="">{{ 'certificate2.allTypes' | translate }}</option>
            <option *ngFor="let type of degreeTypes" [value]="type">
              {{ type }}
            </option>
          </select>
        </div>

        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.academicYear' | translate }}</label>
          <select 
            [(ngModel)]="searchFilters.academicYear"
            class="custom-select"
          >
            <option value="">{{ 'certificate2.allYears' | translate }}</option>
            <option *ngFor="let year of academicYears" [value]="year">
              {{ year }}
            </option>
          </select>
        </div>

        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.fromDate' | translate }}</label>
          <input 
            type="date"
            [(ngModel)]="searchFilters.fromDate"
            class="custom-select"
          >
        </div>

        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.toDate' | translate }}</label>
          <input 
            type="date"
            [(ngModel)]="searchFilters.toDate"
            class="custom-select"
          >
        </div>
      </div>

      <!-- SEARCH ACTIONS -->
      <div class="button-row mt-4">
        <button 
          (click)="searchCertificates()"
          [disabled]="isSearching"
          class="primary-btn action-btn"
        >
          {{ isSearching ? ('certificate2.searching' | translate) : ('certificate2.search' | translate) }}
        </button>
        <button 
          (click)="clearSearch()"
          class="secondary-btn action-btn"
        >
          {{ 'certificate2.clear' | translate }}
        </button>
      </div>

      <!-- SEARCH RESULTS -->
      <div *ngIf="certificates.length > 0" class="mt-4">
        <h4>{{ 'certificate2.searchResults' | translate }} ({{ certificates.length }})</h4>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>{{ 'certificate2.certificateNumber' | translate }}</th>
                <th>{{ 'certificate2.studentName' | translate }}</th>
                <th>{{ 'certificate2.type' | translate }}</th>
                <th>{{ 'certificate2.issuedDate' | translate }}</th>
                <th>{{ 'certificate2.status' | translate }}</th>
                <th>{{ 'certificate2.actions' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let cert of certificates">
                <td>{{ cert.certificateNumber }}</td>
                <td>{{ cert.studentName || 'N/A' }}</td>
                <td>{{ cert.degreeType }}</td>
                <td>{{ cert.issuedDate | date:'mediumDate' }}</td>
                <td>
                  <span [class]="'badge ' + getVerificationClass(cert)">
                    {{ getVerificationStatus(cert) }}
                  </span>
                </td>
                <td>
                  <button 
                    class="btn btn-sm btn-info me-1"
                    (click)="viewCertificate(cert)"
                    title="{{ 'certificate2.view' | translate }}"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-success me-1"
                    (click)="downloadCertificate(cert)"
                    title="{{ 'certificate2.download' | translate }}"
                  >
                    <i class="fas fa-download"></i>
                  </button>
                  <button 
                    *ngIf="!cert.archived"
                    class="btn btn-sm btn-warning"
                    (click)="archiveCertificate(cert.id)"
                    title="{{ 'certificate2.archive' | translate }}"
                  >
                    <i class="fas fa-archive"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- VERIFICATION SECTION -->
    <div class="verification-section fade-card mt-4">
      <h4 class="main-title">{{ 'certificate2.verifyCertificate' | translate }}</h4>
      <div class="selection-grid">
        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.certificateId' | translate }}</label>
          <input 
            type="text"
            [(ngModel)]="verifyCertificateId"
            class="custom-select"
            placeholder="{{ 'certificate2.certificateIdPlaceholder' | translate }}"
          >
        </div>
        <div class="card fade-card">
          <label class="sub-title">{{ 'certificate2.verifiedBy' | translate }}</label>
          <input 
            type="text"
            [(ngModel)]="verifyBy"
            class="custom-select"
            placeholder="{{ 'certificate2.verifierName' | translate }}"
          >
        </div>
        <div class="card fade-card">
          <button 
            (click)="verifyCertificate()"
            [disabled]="!verifyCertificateId || !verifyBy"
            class="primary-btn mt-3"
          >
            {{ 'certificate2.verify' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

</div>