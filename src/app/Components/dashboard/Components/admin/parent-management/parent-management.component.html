<!-- Main Container -->
<div class="admin-teachers-container">
  <!-- Header -->
  <div class="header-section">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
      <div class="mb-3 mb-md-0">
        <h2 class="mb-2">
          <i class="fas fa-users me-2 text-primary-400"></i>
          {{ "parentManagement.header.title" | translate }}
        </h2>
        <p class="text-muted mb-0">
          {{ "parentManagement.header.description" | translate }}
        </p>
      </div>
      <div class="d-flex align-items-center gap-3">
        <span class="badge bg-primary-100 text-primary-600 px-3 py-2">
          <i class="fas fa-users me-1"></i>
          {{ filteredParents.length }}
          {{
            filteredParents.length === 1
              ? ("parentManagement.header.parentsCount" | translate)
              : ("parentManagement.header.parentsCount_plural" | translate)
          }}
        </span>
        <button
          class="btn btn-outline-primary d-flex align-items-center gap-2"
          (click)="loadAllParentsWithChildren()"
          [disabled]="isLoading"
        >
          <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
          <span>{{ "parentManagement.header.refresh" | translate }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="search-box">
          <i class="fas fa-search search-icon"></i>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="searchQuery"
            (input)="onSearch()"
            [placeholder]="'parentManagement2.search.placeholder' | translate"
          />
          @if (searchQuery) {
          <button class="clear-search" (click)="clearSearch()">
            <i class="fas fa-times"></i>
          </button>
          }
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex align-items-center h-100">
          <div class="form-check me-3">
            <input
              class="form-check-input"
              type="checkbox"
              id="showWithStudentsOnly"
              [(ngModel)]="showWithStudentsOnly"
              (change)="applyFilters()"
            />
            <label class="form-check-label" for="showWithStudentsOnly">
              {{ "parentManagement2.filters.showWithStudentsOnly" | translate }}
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="showWithoutStudentsOnly"
              [(ngModel)]="showWithoutStudentsOnly"
              (change)="applyFilters()"
            />
            <label class="form-check-label" for="showWithoutStudentsOnly">
              {{ "parentManagement2.filters.showWithoutStudentsOnly" | translate }}
            </label>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Active Filters -->
    @if (hasActiveFilters()) {
    <div class="filter-tags mt-3">
      @if (searchQuery) {
      <span class="filter-tag">
        {{ "parentManagement2.search.searchingFor" | translate }}: "{{ searchQuery }}"
        <button class="remove-tag" (click)="clearSearch()">
          <i class="fas fa-times"></i>
        </button>
      </span>
      }
      @if (showWithStudentsOnly) {
      <span class="filter-tag active">
        {{ "parentManagement2.filters.withStudents" | translate }}
        <button class="remove-tag" (click)="clearFilter('withStudents')">
          <i class="fas fa-times"></i>
        </button>
      </span>
      }
      @if (showWithoutStudentsOnly) {
      <span class="filter-tag active">
        {{ "parentManagement2.filters.withoutStudents" | translate }}
        <button class="remove-tag" (click)="clearFilter('withoutStudents')">
          <i class="fas fa-times"></i>
        </button>
      </span>
      }
      @if (hasActiveFilters()) {
      <button class="filter-tag" (click)="clearAllFilters()">
        {{ "parentManagement2.filters.clearAll" | translate }}
      </button>
      }
    </div>
    }
  </div>

  <!-- Parent Stats -->
  <div class="parent-stats mb-4">
    <div class="stat-card">
      <div class="stat-value">{{ totalParents }}</div>
      <div class="stat-label">{{ "parentManagement2.stats.totalParents" | translate }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ parentsWithStudents }}</div>
      <div class="stat-label">{{ "parentManagement2.stats.withStudents" | translate }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ totalStudents }}</div>
      <div class="stat-label">{{ "parentManagement2.stats.totalStudents" | translate }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ averageStudentsPerParent }}</div>
      <div class="stat-label">{{ "parentManagement2.stats.avgStudents" | translate }}</div>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary mb-3" role="status">
      <span class="visually-hidden">{{ "parentManagement.loading.title" | translate }}</span>
    </div>
    <h4 class="mb-2">{{ "parentManagement.loading.title" | translate }}</h4>
    <p class="text-muted">{{ "parentManagement.loading.message" | translate }}</p>
  </div>
  }

  <!-- Parents Grid -->
  @if (!isLoading && filteredParents.length > 0) {
  <div class="row g-4">
    @for (parent of filteredParents; track parent.id) {
    <div class="col-md-6 col-lg-4">
      <div class="parent-card h-100">
        <!-- Card Header -->
        <div class="parent-card-header">
          <div class="parent-card-icon">
            <i class="fas fa-user"></i>
          </div>
          <div class="parent-info">
            <h5 class="parent-name mb-2">{{ parent.fullName }}</h5>
            <div class="parent-contact">
              <div class="contact-item">
                <i class="fas fa-envelope"></i>
                <span class="contact-text">{{ parent.email }}</span>
              </div>
              <div class="contact-item">
                <i class="fas fa-phone"></i>
                <span class="contact-text">
                  {{ parent.contactInfo || ("parentManagement.parentCard.noPhone" | translate) }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Card Body -->
        <div class="parent-card-body">
          <!-- Students Section Header -->
          <div class="students-section-header">
            <div class="d-flex align-items-center">
              <div class="students-icon">
                <i class="fas fa-user-graduate"></i>
              </div>
              <h6 class="students-title mb-0">
                {{ "parentManagement.parentCard.associatedStudents" | translate }}
              </h6>
            </div>
            <span class="students-count">
              {{ parent.students.length }}
            </span>
          </div>

          <!-- Students Content -->
          <div class="students-content">
            @if (parent.students.length === 0) {
            <div class="no-students text-center py-4" (click)="openAddStudentModal(parent)">
              <div class="no-students-icon mb-3">
                <i class="fas fa-user-plus"></i>
              </div>
              <p class="no-students-text mb-3">
                {{ "parentManagement.parentCard.noStudents.title" | translate }}
              </p>
              <button class="btn btn-outline-primary btn-sm px-3">
                <i class="fas fa-plus me-2"></i>
                {{ "parentManagement.parentCard.noStudents.button" | translate }}
              </button>
            </div>
            } @else {
            <!-- Students List -->
            <div class="students-list">
              @for (student of parent.students; track student.id) {
              <div class="student-item">
                <div class="student-info">
                  <div class="student-avatar">
                    <i class="fas fa-user-graduate"></i>
                  </div>
                  <div class="student-details">
                    <h6 class="student-name mb-1">{{ student.fullName }}</h6>
                    <span class="student-relation" [ngClass]="'relation-' + (student.relation || 'other')">
                      {{
                        student.relation === "father"
                          ? ("parentManagement.parentCard.relations.father" | translate)
                          : student.relation === "mother"
                          ? ("parentManagement.parentCard.relations.mother" | translate)
                          : student.relation === "guardian"
                          ? ("parentManagement.parentCard.relations.guardian" | translate)
                          : ("parentManagement.parentCard.relations.other" | translate)
                      }}
                    </span>
                  </div>
                </div>
                <button
                  class="btn btn-sm btn-icon btn-danger"
                  (click)="removeStudent(parent.id, student.id); $event.stopPropagation()"
                  [disabled]="isRemovingStudent"
                  [title]="'parentManagement.parentCard.removeTooltip' | translate"
                >
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
              }
            </div>

            <!-- Add Student Button -->
            <div class="add-student-section">
              <button
                class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2 py-2"
                (click)="openAddStudentModal(parent)"
                [disabled]="isAddingStudent"
              >
                <i class="fas fa-plus"></i>
                <span>{{ "parentManagement.parentCard.addStudent" | translate }}</span>
              </button>
            </div>
            }
          </div>
        </div>
      </div>
    </div>
    }
  </div>
  }

  <!-- Empty State -->
  @if (!isLoading && filteredParents.length === 0) {
  <div class="empty-state-container text-center py-6">
    <div class="empty-state-icon mb-4">
      <i class="fas fa-users"></i>
    </div>
    <h4 class="empty-state-title mb-3">
      {{ hasActiveFilters() 
        ? ("parentManagement2.emptyState.noResults" | translate) 
        : ("parentManagement2.emptyState.title" | translate) 
      }}
    </h4>
    <p class="empty-state-text mb-5">
      {{ hasActiveFilters()
        ? ("parentManagement2.emptyState.noResultsDescription" | translate)
        : ("parentManagement2.emptyState.description" | translate)
      }}
    </p>
    @if (hasActiveFilters()) {
    <button class="btn btn-primary btn-lg" (click)="clearAllFilters()">
      <i class="fas fa-times me-2"></i>
      {{ "parentManagement2.filters.clearAll" | translate }}
    </button>
    }
  </div>
  }
</div>

<!-- Modal for Adding Student -->
<div *ngIf="showAddStudentModal" class="modal fade show" style="display: block;">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="modal-title-wrapper">
          <div class="modal-icon">
            <i class="fas fa-user-plus"></i>
          </div>
          <div>
            <h5 class="modal-title mb-1">{{ "parentManagement.addStudentModal.header.title" | translate }}</h5>
            <p class="modal-subtitle mb-0">
              {{ "parentManagement.addStudentModal.header.description" | translate }}
              <strong class="text-primary">{{ selectedParent?.fullName }}</strong>
            </p>
          </div>
        </div>
        <button
          type="button"
          class="btn-close btn-close-lg"
          (click)="closeAddStudentModal()"
          [disabled]="isAddingStudent"
          [attr.aria-label]="'parentManagement.addStudentModal.buttons.close' | translate"
        ></button>
      </div>

      <!-- Modal Body -->
      <form [formGroup]="addStudentForm" (ngSubmit)="addStudent()" class="modal-body">
        <!-- Student Selection -->
        <div class="form-section">
          <label class="form-label">
            <div class="label-icon">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div class="label-text">
              {{ "parentManagement.addStudentModal.form.studentSelection.label" | translate }}
              <span class="required">*</span>
            </div>
          </label>
          <select
            formControlName="studentId"
            class="form-select-lg"
            [class.is-invalid]="addStudentForm.get('studentId')?.invalid && addStudentForm.get('studentId')?.touched"
          >
            <option value="" disabled selected>
              {{ "parentManagement.addStudentModal.form.studentSelection.placeholder" | translate }}
            </option>
            @for (student of filteredAvailableStudents; track student.id) {
            <option [value]="student.id" [disabled]="getStudentAlreadyLinked(student.id)">
              {{ student.fullName }}
              @if (getStudentAlreadyLinked(student.id)) {
              <span class="text-muted">
                ({{ "parentManagement.addStudentModal.form.studentSelection.alreadyLinked" | translate }})
              </span>
              }
            </option>
            }
          </select>
          @if (addStudentForm.get('studentId')?.invalid && addStudentForm.get('studentId')?.touched) {
          <div class="invalid-feedback">
            <i class="fas fa-exclamation-circle me-2"></i>
            {{ "parentManagement.addStudentModal.form.studentSelection.validationError" | translate }}
          </div>
          }
        </div>

        <!-- Relation Selection -->
        <div class="form-section">
          <label class="form-label">
            <div class="label-icon">
              <i class="fas fa-handshake"></i>
            </div>
            <div class="label-text">
              {{ "parentManagement.addStudentModal.form.relation.label" | translate }}
              <span class="required">*</span>
            </div>
          </label>
          <div class="relation-grid">
            @for (option of relationOptions; track option.value) {
            <label class="relation-option">
              <input
                type="radio"
                formControlName="relation"
                [value]="option.value"
                class="visually-hidden"
              />
              <div class="relation-card">
                <div class="relation-icon">
                  @if (option.value === 'father') {
                  <i class="fas fa-male"></i>
                  } @else if (option.value === 'mother') {
                  <i class="fas fa-female"></i>
                  } @else if (option.value === 'guardian') {
                  <i class="fas fa-user-shield"></i>
                  } @else {
                  <i class="fas fa-user"></i>
                  }
                </div>
                <div class="relation-label">
                  {{ option.label | translate }}
                </div>
              </div>
            </label>
            }
          </div>
          @if (addStudentForm.get('relation')?.invalid && addStudentForm.get('relation')?.touched) {
          <div class="invalid-feedback">
            <i class="fas fa-exclamation-circle me-2"></i>
            {{ "parentManagement.addStudentModal.form.relation.validationError" | translate }}
          </div>
          }
        </div>
      </form>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-lg btn-secondary"
          (click)="closeAddStudentModal()"
          [disabled]="isAddingStudent"
        >
          {{ "parentManagement.addStudentModal.buttons.cancel" | translate }}
        </button>
        <button
          type="submit"
          class="btn btn-lg btn-primary"
          (click)="addStudent()"
          [disabled]="addStudentForm.invalid || isAddingStudent"
        >
          @if (isAddingStudent) {
          <span class="d-flex align-items-center gap-2">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            {{ "parentManagement.addStudentModal.buttons.submit.adding" | translate }}
          </span>
          } @else {
          <span class="d-flex align-items-center gap-2">
            <i class="fas fa-link"></i>
            {{ "parentManagement.addStudentModal.buttons.submit.default" | translate }}
          </span>
          }
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showAddStudentModal" class="modal-backdrop fade show"></div>

<!-- CONFIRMATION MODAL (Placed outside main container) -->
<div *ngIf="isConfirmModalOpen" class="modal fade show" style="display: block; z-index: 1054">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Action</h5>
        <button type="button" class="btn-close" (click)="closeConfirm()"></button>
      </div>
      <div class="modal-body">
        <p>{{ confirmModalMessage }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeConfirm()">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="confirmYes()">
          Yes, Continue
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="isConfirmModalOpen" class="modal-backdrop fade show" style="z-index: 1053"></div>